{% extends "core.twig" %}
{% block title %}{{ _('Ressource') }} {{ a.host }} - {{ r.name }}  {% endblock %}
{% block meta %}
<style>
table.table-hover tr td a {
	display: block;
	width: 100%;
	height: 100%;
}
</style>
{% endblock %}
{% block contentHeader %}
        {{ _('Ressource') }}
        <small>{{ _('on') }} {{ a.host }} : {{ r.name }} </small>
{% endblock %}
{% block content %}
      <div class="row">
  {% if monitorItems is defined and monitorItems is not null %}
        <div class="col-md-3">
          <div class="box box-default">
            <div class="box-header with-border">
              <h3 class="box-title">{{ _('Monitoring status') }}</h3>
              <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                </button>
              </div>
            </div>
	    <div class="box-body" id="gfx1"></div>
            <div class="box-footer no-padding">
              <ul class="nav nav-pills nav-stacked">
    {% for e in activeEvent %}
                <li><a href="{{ path_for('event', { 'id': e.id|e }) }}">{{ e.property }}
                  <span class="pull-right {{ e.color }}">{{ e.current_value }}{{ e.encode }}{{ e.value }}</span></a></li>
    {% endfor %}
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="box box-default">
            <div class="box-header with-border">
              <h3 class="box-title">{{ _('Events history') }}</h3>
              <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="box-body table-responsive">
	      <table class="table table-striped table-hover">
	      <thead><tr>
               <th>{{ _('id') }}</th>
               <th>{{ _('start') }}</th>
               <th>{{ _('end') }}</th>
               <th>{{ _('property') }}</th>
               <th>{{ _('value') }}</th>
               <th>{{ _('rule') }}</th>
	      </tr></thead><tbody>
    {% for h in monitorHistory %}
               <tr class="{{ h.color }}">
                <td><a  class="{{ h.color }}" href="{{ path_for('event', { 'id': h.id|e }) }}">{{ h.id }}</a></td>
		<td><a  class="{{ h.color }}" href="{{ path_for('event', { 'id': h.id|e }) }}">{{ h.start_time }}</a></td>
                <td><a  class="{{ h.color }}" href="{{ path_for('event', { 'id': h.id|e }) }}">{{ h.end_time }}</a></td>
                <td><a  class="{{ h.color }}" href="{{ path_for('event', { 'id': h.id|e }) }}">{{ h.property }}</a></td>
                <td><a  class="{{ h.color }}" href="{{ path_for('event', { 'id': h.id|e }) }}">{{ h.current_value }}</a></td>
                <td><a  class="{{ h.color }}" href="{{ path_for('event', { 'id': h.id|e }) }}">{{ h.encode }}{{ h.value }}</a></td>
               </tr>
    {% endfor %}
	      </tbody>
	     </table>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="box box-default">
            <div class="box-header with-border">
              <h3 class="box-title">{{ _('Monitoring items') }}</h3>
              <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                </button>
              </div>
            </div>
	    <div class="box-body" id="gfx2"></div>
            <div class="box-footer no-padding">
              <ul class="nav nav-pills nav-stacked">
    {% for e in monitorList %}
                <li><a>{{ e.property }}
                  <span class="pull-right {{ e.color }}">{{ e.encode }}{{ e.value }}</span></a></li>
    {% endfor %}
            </div>
          </div>
        </div>
  {% endif %}
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="box box-default">
            <div class="box-header with-border">
              <h3 class="box-title">{{ _('Graphics') }}</h3>
	      <div class="box-tools">
		<!-- TODO: add a dropdown to select the period -->
                    <div class="btn-group">
                      <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                          Period <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                          <li><a onclick="setPeriod('all')">All</a></li>
                          <li><a onclick="setPeriod('week')">Last week</a></li>
                          <li><a onclick="setPeriod('yesterday')">Yesterday</a></li>
                          <li><a onclick="setPeriod('today')">Today</a></li>
                          <li><a onclick="setPeriod('hour')">Last hour</a></li>
			  <!--<li><a onclick="setPeriod('test')">test</a></li>-->
                        </ul>
                      </div>
                    </div>

	      </div>
            </div>
            <div class="box-body">
	     <div class="chart">
	      <div id="morrisChart"></div>
	     </div>
            </div>
          </div>
        </div>
      </div>
{% endblock %}
{% block scripts %}
<script>
  {% if monitorItems is defined and monitorItems is not null %}
if (!Date.now) {
    Date.now = function() { return new Date().getTime(); }
}
  var graph;
  var PieData1 = [];
    {% for m in monitorStatus %}
  PieData1.push({
      value: {{ m.cnt }},
      color: "{{ m.color }}",
      highlight: "{{ m.color }}",
      label: "{{ _(m.name) }}"
    });
    {% endfor %}
  watchedDonut("gfx1", PieData1);

  var PieData2 = [];
    {% for m in monitorItems %}
  PieData2.push({
      value: {{ m.cnt }},
      color: "{{ m.color }}",
      highlight: "{{ m.color }}",
      label: "{{ _(m.name) }}"
    });
    {% endfor %}
  watchedDonut("gfx2", PieData2);
  {% endif %}

$.getJSON( "{{ path_for('apiRessource', { 'aid': a.id, 'rid': r.id, 'name': r.type }) }}", function( data ) {
	var ykeys = [];
	$.each(data[0], function(index, value) {
		if (index!='timestamp' && index.match(/^min/)==null && index.match(/^max/)==null)
			ykeys.push(index);
	});
	graph = new Morris.Area({
		element: 'morrisChart',  
		data: data, 
		hideHover: true,
		xkey: 'timestamp', 
		pointSize:0,fillOpacity:0.3,
		ykeys: ykeys, labels: ykeys
	});
});

function updateLiveGraph(url) {
  $.getJSON(url, function(results) {
  	var ykeys = [];
	$.each(results[0], function(index, value) {
		if (index!='timestamp' && index.match(/^min/)==null && index.match(/^max/)==null)
			ykeys.push(index);
	});
	graph.options.ykeys=ykeys;
	graph.options.labels=ykeys;
	graph.setData(results); 
  });
}

function setPeriod(p) {
	var baseurl='{{ path_for('apiRessource', { 'aid': a.id, 'rid': r.id, 'name': r.type }) }}';
	var url;
	switch(p) {
	case "all": url=baseurl;break;
	case "week": url=baseurl+"/"+(Math.floor(Date.now())-(3600000*24*7));break;
	case "yesterday": url=baseurl+"/"+((Math.floor(Date.now()/(3600000*24))-1)*(3600000*24))+"/"+(Math.floor(Date.now()/(3600000*24))*(3600000*24));break;
	case "today": url=baseurl+"/"+(Math.floor(Date.now()/(3600000*24))*(3600000*24));break;
	case "hour": url=baseurl+"/"+(Date.now()-3600000);break;
	case "test": url=baseurl+"/"+(Date.now()-6*3600000-4*600000)+"/"+(Date.now()-5*3600000+60000);break;
	default:
		return false;
	}
	updateLiveGraph(url);
	return true;
}

</script>
{% endblock %}
